AjaxReviews.grid.Items=function(config){(config=config||{}).id||(config.id="ajaxreviews-grid-ratings"),Ext.applyIf(config,{url:AjaxReviews.config.connector_url,fields:this.getFields(config),columns:this.getColumns(config),tbar:this.getTopBar(config),sm:new Ext.grid.CheckboxSelectionModel,baseParams:{action:"mgr/rating/getlist"},listeners:{rowDblClick:function(grid,rowIndex,e){var row=grid.store.getAt(rowIndex);this.updateItem(grid,e,row)}},viewConfig:{forceFit:!0,enableRowBody:!0,autoFill:!0,showPreview:!0,scrollOffset:0,getRowClass:function(rec){return rec.data.active?"":"ajaxreviews-grid-row-disabled"}},paging:!0,remoteSort:!0,autoHeight:!0}),AjaxReviews.grid.Items.superclass.constructor.call(this,config),this.store.on("load",(function(){this._getSelectedIds().length&&this.getSelectionModel().clearSelections()}),this)},Ext.extend(AjaxReviews.grid.Items,MODx.grid.Grid,{windows:{},getMenu:function(grid,rowIndex){var ids=this._getSelectedIds(),row=grid.getStore().getAt(rowIndex),menu=AjaxReviews.utils.getMenu(row.data.actions,this,ids);this.addContextMenuItem(menu)},createItem:function(btn,e){var w=MODx.load({xtype:"ajaxreviews-rating-window-create",id:Ext.id(),listeners:{success:{fn:function(){this.refresh()},scope:this}}});w.reset(),w.setValues({active:!0}),w.show(e.target)},updateItem:function(btn,e,row){if(void 0!==row)this.menu.record=row.data;else if(!this.menu.record)return!1;var id=this.menu.record.id;MODx.Ajax.request({url:this.config.url,params:{action:"mgr/rating/get",id:id},listeners:{success:{fn:function(r){var w=MODx.load({xtype:"ajaxreviews-rating-window-update",id:Ext.id(),record:r,listeners:{success:{fn:function(){this.refresh()},scope:this}}});w.reset(),w.setValues(r.object),w.show(e.target)},scope:this}}})},removeItem:function(){var ids=this._getSelectedIds();return!!ids.length&&(MODx.msg.confirm({title:ids.length>1?_("ajaxreviews_items_remove"):_("ajaxreviews_item_remove"),text:ids.length>1?_("ajaxreviews_items_remove_confirm"):_("ajaxreviews_item_remove_confirm"),url:this.config.url,params:{action:"mgr/rating/remove",ids:Ext.util.JSON.encode(ids)},listeners:{success:{fn:function(){this.refresh()},scope:this}}}),!0)},getFields:function(){return["id","user_id","rating","actions"]},getColumns:function(){return[{header:_("ajaxreviews_item_id"),dataIndex:"id",sortable:!0,width:70},{header:_("ajaxreviews_item_user_id"),dataIndex:"user_id",sortable:!0,width:70},{header:_("ajaxreviews_item_rating"),dataIndex:"rating",sortable:!1,width:50}]},getTopBar:function(){return[{text:'<i class="icon icon-plus"></i>&nbsp;'+_("ajaxreviews_rating_create"),handler:this.createItem,scope:this},"->",{xtype:"ajaxreviews-field-search",width:250,description:"User ID",listeners:{search:{fn:function(field){this._doSearch(field)},scope:this},clear:{fn:function(field){field.setValue(""),this._clearSearch()},scope:this}}}]},onClick:function(e){var elem=e.getTarget();if("BUTTON"==elem.nodeName){var row=this.getSelectionModel().getSelected();if(void 0!==row){var action=elem.getAttribute("action");if("showMenu"==action){var ri=this.getStore().find("id",row.id);return this._showMenu(this,ri,e)}if("function"==typeof this[action])return this.menu.record=row.data,this[action](this,e)}}return this.processEvent("click",e)},_getSelectedIds:function(){var ids=[],selected=this.getSelectionModel().getSelections();for(var i in selected)selected.hasOwnProperty(i)&&ids.push(selected[i].id);return ids},_doSearch:function(tf){this.getStore().baseParams.query=tf.getValue(),this.getBottomToolbar().changePage(1)},_clearSearch:function(){this.getStore().baseParams.query="",this.getBottomToolbar().changePage(1)}}),Ext.reg("ajaxreviews-grid-ratings",AjaxReviews.grid.Items);